<script>
  /**
   * @polymerBehavior dragDropzoneBehavior
   */
  dragDropzoneBehavior = {
    properties: {
      /**
       * Set to `true` while an item is being dragged over the dropzone
       */
      itemDragged: {
        type: Boolean,
        value: false,
        readOnly: true
      },
      /**
       * Metadata describing which file types are accepted.
       * You can add more than one file type by separating them with
       * a comma, e.g "application/pdf, image/png"
       *
       * @type {{types: String}}
       */
      accept: {
        type: String,
        value: ''
      }

      /**
       * Fired when an item is dropped on the dropzone
       *
       * @event item-dropped
       * @param {String} type Type of element dropped, can be 'DOMElement'
       * or 'file'
       * @param {Array} items List of dropped items
       * @param {Object} position x/y coordinates of drop position
       */

       /**
        * Fired if an item is dropped but doesn't pass the `accept` file type
        * checks
        *
        * @event item-error
        * @param {String} text The error message
        */
    },

    attached: function() {
      this.addEventListener('dragenter', this._activateDropzone.bind(this));
      this.addEventListener('dragleave', this._deactivateDropzone.bind(this));
      this.addEventListener('dragover', this._cancelDefault.bind(this));
      this.addEventListener('drop', this._handleItemDrop.bind(this));
      window.addEventListener('paste', this._handlePaste.bind(this))
    },

    _handleItemDrop: function(e) {
      const position = this._createPoint(e.clientX, e.clientY);
      const itemType = e.dataTransfer.getData('type');

      switch (itemType) {
        case 'DOMElement':
          this._itemDropped('DOMElement', [e.dataTransfer.getData('data')], position);
          break;
        default:
          // @NOTE `fake-files` data used for testing
          const files = e.dataTransfer.getData('fake-files') ?
            e.dataTransfer.getData('fake-files') :
            e.dataTransfer.files;

          this._filesDropped('file', files, position);
      }

      this._deactivateDropzone(e);
    },

    _filesDropped: function(type, files, position) {
      if (this._haveInvalidTypes(files)) {
        this.fire('item-error', {text: 'Unsupported file type'});
        return false;
      }

      this._itemDropped(type, files, position);
    },

    _itemDropped: function(type, items, position) {
      this.fire('item-dropped', {type, items, position});
    },

    _activateDropzone: function(e) {
      this._setItemDragged(true);
      this._cancelDefault(e);
    },

    _deactivateDropzone: function(e) {
      this._setItemDragged(false);
      this._cancelDefault(e);
    },

    _cancelDefault: function(e) {
      if (e) {
        e.preventDefault();
      }
    },

    _handlePaste: function(e) {
      const position = this._createPoint();

      // @NOTE `fakeClipboardData` used for testing
      if (e.detail && e.detail.fakeClipboardData) {
        this._filesDropped('file', e.detail.fakeClipboardData.items, position);

        return false;
      }

      const items = (e.clipboardData || e.originalEvent.clipboardData).items;

      for (let index in items) {
        if ({}.hasOwnProperty.call(items, index)) {
          const item = items[index];

          if (item.kind === "file") {
            this._filesDropped('file', [item.getAsFile()], position);
          }
        }
      }
    },

    _createPoint: function(x = window.innerWidth / 2, y = window.innerHeight / 2) {
      return { x, y };
    },

    _haveInvalidTypes: function(files) {
      files = [...files];

      if (files.some(this._isInvalidType.bind(this))) {
        return true;
      }

      return false;
    },

    _isInvalidType: function(file) {
      if (!this.accept.length) {
        return false;
      }

      if (!file) {
        return true;
      }

      const fileTypeOk = this.accept.split(',')
        .map(item => item.trim())
        .includes(file.type);

      return !fileTypeOk;
    }
  };
</script>
